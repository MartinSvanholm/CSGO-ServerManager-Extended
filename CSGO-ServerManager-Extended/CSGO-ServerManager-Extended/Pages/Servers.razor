@page "/servers"
@using CsgoServerInterface.Exceptions

@inject ICsgoServerService CsgoServerService
@inject ISettingsService settingsService
@inject ISnackbar Snackbar
@inject NavigationManager navigation
@inject ICsgoServerData csgoServerData

<MudTable RowClass="row-border" Height="85vh" Items="@csgoServers" RowStyle="cursor: pointer;" Hover="true" Loading="@_loading" OnRowClick="RowClickEvent" T="ICsgoServer" LoadingProgressColor="Color.Info" Striped="true" Elevation="0" FixedHeader=true>
    <ToolBarContent>
        <MudText Typo="Typo.h6">Your servers</MudText>
        <MudSpacer />
        <MudStack Row="true">
            <MudIconButton Icon="@Icons.Filled.Refresh" OnClick="(async () => await GetServersAsync())"></MudIconButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="(() => OpenEditDialog(EditType.Create, null))">Add server</MudButton>
        </MudStack>
    </ToolBarContent>
    <HeaderContent>
        <MudTh Style="font-weight: bold;">Name</MudTh>
        <MudTh Style="font-weight: bold;">Connection Ip</MudTh>
        <MudTh Style="font-weight: bold; text-align: center;">Status</MudTh>
        <MudTh Style="font-weight: bold; text-align: center;">Players online</MudTh>
        <MudTh></MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate >
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Connection Ip" HideSmall="true">@context.ConnectionIp</MudTd>
        <MudTd Style="text-align: center" DataLabel="Status">@context.Status</MudTd>
        <MudTd Style="text-align: center" id="td-column" DataLabel="Players online">0</MudTd>
        <MudTd HideSmall="true">
            <MudIconButton Icon="@Icons.Filled.Edit" OnClick="(() => OpenEditDialog(EditType.Edit, context))"></MudIconButton>
        </MudTd>
        <MudTd HideSmall="true">
            <MudIconButton Icon="@Icons.Filled.Delete" OnClick="(async () => await OnDeleteConfirmShow(context))"></MudIconButton>
        </MudTd>
    </RowTemplate>
</MudTable>

<CsgoServerDialog isVisible="isVisible" ChangeVisibility="(async (bool isSucces) => await OnVisibilityChanged(isSucces))" TempServer="tempServer" EditType="_editType" />

<MudMessageBox @ref="confirmMessageBox" Title="Warning" CancelText="Cancel">
    <MessageContent>
        Deleting cannot be undone!
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.DeleteForever">Delete!</MudButton>
    </YesButton>
</MudMessageBox>

@code {
    private bool isVisible = false;
    private List<ICsgoServer> csgoServers = new();
    private CsgoServer tempServer = new();
    private EditType _editType;
    private bool _loading = true;
    private MudMessageBox confirmMessageBox { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await GetServersAsync();
    }

    private void RowClickEvent(TableRowClickEventArgs<ICsgoServer> args)
    {
        navigation.NavigateTo($"/server/{args.Item.Id}", true);
    }

    private async Task GetServersAsync()
    {
        try
        {
            csgoServers = new();
            if(settingsService.DathostAccountIsConnected)
                csgoServers.AddRange(await CsgoServerService.GetDatHostServers());
            csgoServers.AddRange(await csgoServerData.CsgoServers_GetAll());
            _loading = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (CsgoServerException serverException) 
        {
            Snackbar.Add($"Could not load your DathostServers: {serverException.Message}", Severity.Warning);
            _loading = false;
        }
        catch (Exception e)
        {
            Snackbar.Add($"Something went wrong: {e.Message}", Severity.Error);
            _loading = false;
        }
    }

    private void OpenEditDialog(EditType editType, ICsgoServer csgoServer)
    {
        _editType = editType;
        if (_editType == EditType.Create)
        {
            isVisible = true;
        }
        else
        {
            if(csgoServer is DatHostCsgoServer)
            {
                Snackbar.Add("You cannot remove servers from dathost", Severity.Warning);
                return;
            }

            tempServer = (CsgoServer)csgoServer;
            isVisible = true;
        }
    }

    private async Task DeleteServerAsync(ICsgoServer csgoServer)
    {
        if(csgoServer is CsgoServer)
        {
            try
            {
                await csgoServerData.CsgoServer_Delete((CsgoServer)csgoServer);
                csgoServers.Remove(csgoServer);
                Snackbar.Add($"Deleted server \"{csgoServer.Name}\"", Severity.Info);
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception e)
            {
                Snackbar.Add(e.Message, Severity.Info);
            }

        } else
        {
            Snackbar.Add("You cannot remove servers from dathost", Severity.Warning);
            return;
        }
    }

    private async Task OnDeleteConfirmShow(ICsgoServer csgoServer)
    {
        bool? result = await confirmMessageBox.Show() == null ? false : true;

        if (result != null && (bool)result)
            await DeleteServerAsync(csgoServer);
        else
            return;
    }

    private async Task OnVisibilityChanged(bool isSucces)
    {
        tempServer = new();
        isVisible = !isVisible;

        if(isSucces)
        {
            await GetServersAsync();
            await InvokeAsync(StateHasChanged);
        }
    }
}