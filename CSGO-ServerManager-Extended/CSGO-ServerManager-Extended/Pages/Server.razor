@page "/server"
@inject ICsgoServerService CsgoServerService
@inject ICsgoServerRepository CsgoServerRepository
@inject ISnackbar _snackBar;

@if(CsgoServer != null) {
    <ServerComponent Server="CsgoServer" OnServerChange="(ICsgoServer tempServer) => OnServerChanged(tempServer)">
        <ServerHeader>
            <StandardServerHeader Server="CsgoServer" StartStopServer="(async () => await StartStopServer())"/>
        </ServerHeader>
    </ServerComponent>
}

@code {
    [Parameter, SupplyParameterFromQuery]
    public string ServerId { get; set; }

    [Parameter, SupplyParameterFromQuery]
    public string ServerType { get; set; }

    private ICsgoServer CsgoServer { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if(ServerType == CsgoServerConstants.NormalCsgoServerType)
            {
                CsgoServer = await CsgoServerRepository.GetCsgoServerById(ServerId);
            } 
            else
            {
                CsgoServer = await CsgoServerService.GetDatHostServer(ServerId);
            }                
        }
        catch (Exception e)
        {
            _snackBar.Add(e.Message);
        }
    }

    private async Task StartStopServer()
    {
        try
        {
            await CsgoServerService.StartStopServer(CsgoServer);
            if (CsgoServer.Booting)
                _snackBar.Add("Starting server", Severity.Info);
            else
                _snackBar.Add("Stopping server", Severity.Info);
        }
        catch (Exception e)
        {
            _snackBar.Add(e.Message, Severity.Error);
        }

        StateHasChanged();
    }

    private void OnServerChanged(ICsgoServer csgoServer)
    {
        CsgoServer = csgoServer;
        StateHasChanged();
    }
}